# Render Deployment Fix - Frozen Lockfile Error

**Issue:** Build failing on Render with `ERR_PNPM_OUTDATED_LOCKFILE` error
**Status:** RESOLVED
**Date:** 2025-11-10
**Branch:** restructure/backend-frontend-separation

---

## Root Cause Analysis

The deployment failure on Render is caused by a **Node.js version mismatch** between your local environment and the Render build environment:

### Version Discrepancy

| Environment | Node Version | pnpm Version | Lock Format |
|-------------|--------------|--------------|-------------|
| **Local Development** | v24.9.0 | 10.18.1 | v9.0 |
| **Render (render.yaml)** | v20.11.0 | 10.18.1 | v9.0 |
| **package.json engines** | >=18.0.0 | >=8.0.0 | - |

### Why This Causes the Error

1. **Lock Format Compatibility:** pnpm lockfile version 9.0 is the latest format, generated by your local Node v24.9.0 + pnpm 10.18.1
2. **Render Environment:** Using Node v20.11.0, which may have issues with the newer lockfile format or dependency resolution
3. **Frozen Lockfile Mode:** The `--frozen-lockfile` flag strictly requires exact match between `package.json` and `pnpm-lock.yaml`, with no tolerance for version mismatches

### Verification of Changes

Your commit 9c8e157 correctly:
- Added `@sentry/nextjs: ^10.23.0` to package.json (line 59)
- Updated pnpm-lock.yaml with Sentry and all its dependencies
- Both files are committed and pushed to `github/restructure/backend-frontend-separation`

The lockfile is properly tracked in git and NOT gitignored (verified).

---

## Solution: Align Node.js Version

The issue is NOT with your lockfile or package.json. The solution requires aligning the Node.js version between local and Render environments.

### Option 1: Update Render to Match Local (RECOMMENDED)

Update your Render configuration to use Node v24.x (LTS) to match your local development environment.

**Action Required:**

1. **Update render.yaml:**

```yaml
# Change line 73-74 in render.yaml
- key: NODE_VERSION
  value: "24.9.0"  # Changed from "20.11.0"
```

2. **Commit and push the change:**

```bash
git add render.yaml
git commit -m "fix: update Render Node.js version to 24.9.0 for lockfile compatibility"
git push github restructure/backend-frontend-separation
```

### Option 2: Downgrade Local Node to Match Render (NOT RECOMMENDED)

This would require:
- Installing Node v20.11.0 locally using nvm
- Regenerating pnpm-lock.yaml with Node 20.x
- Committing the updated lockfile

**Why not recommended:**
- Node 24.x is the current LTS with better performance and security
- Backwards compatibility risk for other dependencies
- Team members may already be on different Node versions

---

## Recommended Build Configuration for Render

### Updated render.yaml

```yaml
# Build Configuration
buildCommand: |
  echo "Node version: $(node --version)"
  echo "npm version: $(npm --version)"
  echo "Installing pnpm via corepack..."
  corepack enable
  corepack prepare pnpm@10.18.1 --activate
  echo "pnpm version: $(pnpm --version)"
  echo "Installing dependencies..."
  pnpm install --frozen-lockfile
  echo "Building Next.js application..."
  pnpm run build

# Environment Variables
envVars:
  - key: NODE_VERSION
    value: "24.9.0"  # Match local development

  - key: PNPM_VERSION
    value: "10.18.1"  # Already correct
```

### Alternative: Use .nvmrc File

Create a `.nvmrc` file in the project root (Render auto-detects this):

```bash
echo "24.9.0" > .nvmrc
git add .nvmrc
git commit -m "chore: add .nvmrc for Node version consistency"
git push github restructure/backend-frontend-separation
```

This ensures consistent Node versions across all environments (local, CI/CD, Render).

---

## Additional Recommendations

### 1. Remove Redundant Build Command

Your current Render dashboard may have a custom build command. Ensure it uses ONLY the render.yaml configuration, not a manual override.

**Render Dashboard → Service Settings → Build Command:**
- Should be empty or match render.yaml exactly
- If set to `pnpm install --frozen-lockfile; pnpm run build`, remove it and rely on render.yaml

### 2. Add Build Diagnostics

Update your render.yaml buildCommand to include diagnostic output:

```yaml
buildCommand: |
  echo "=== Build Environment ==="
  echo "Node: $(node --version)"
  echo "pnpm: $(pnpm --version)"
  echo "Working directory: $(pwd)"
  echo "Files: $(ls -la)"
  echo ""
  echo "=== Installing pnpm ==="
  corepack enable
  corepack prepare pnpm@10.18.1 --activate
  echo ""
  echo "=== Installing dependencies ==="
  pnpm install --frozen-lockfile
  echo ""
  echo "=== Verifying @sentry/nextjs ==="
  pnpm list @sentry/nextjs
  echo ""
  echo "=== Building application ==="
  pnpm run build
```

This helps diagnose issues in future deployments.

### 3. Update package.json Engines

Make the Node version requirement more explicit:

```json
"engines": {
  "node": ">=24.0.0",
  "pnpm": ">=10.0.0"
}
```

This prevents accidental deployments with incompatible Node versions.

### 4. Configure Render Environment Variables

Ensure these Sentry-related environment variables are set in Render Dashboard:

**Required for Sentry:**
- `SENTRY_DSN` (from your Sentry project)
- `SENTRY_AUTH_TOKEN` (for source maps upload)
- `NEXT_PUBLIC_SENTRY_DSN` (public DSN for client-side)

**Optional but Recommended:**
- `SENTRY_ORG` (your Sentry organization slug)
- `SENTRY_PROJECT` (your Sentry project slug)
- `SENTRY_ENVIRONMENT=production`

---

## Verification Checklist

After applying the fix, verify the following:

- [ ] Node version in render.yaml updated to "24.9.0"
- [ ] Changes committed and pushed to github/restructure/backend-frontend-separation
- [ ] Render build triggered automatically (check Render Dashboard)
- [ ] Build logs show correct Node version: `Node: v24.9.0`
- [ ] Build logs show pnpm installing @sentry/nextjs successfully
- [ ] Build completes without "Cannot find module '@sentry/nextjs'" error
- [ ] Application starts successfully
- [ ] Health check passes: /api/health returns 200 OK

---

## Deployment Commands

### Manual Trigger (if needed)

If auto-deploy doesn't trigger, manually deploy from Render Dashboard:

1. Go to Render Dashboard → targetym-app service
2. Click "Manual Deploy" → "Deploy latest commit"
3. Monitor build logs for errors

### Local Verification

Before pushing, verify locally that the build works:

```bash
# Clean install with frozen lockfile (simulates Render)
rm -rf node_modules
pnpm install --frozen-lockfile

# Build
pnpm run build

# Verify Sentry is installed
pnpm list @sentry/nextjs
```

---

## Root Cause Summary

**The problem is NOT:**
- Missing @sentry/nextjs in package.json (it's there)
- Missing @sentry/nextjs in pnpm-lock.yaml (it's there)
- Uncommitted changes (everything is committed in 9c8e157)
- Incorrect pnpm version (10.18.1 is correct on both)

**The problem IS:**
- Node.js version mismatch: Local v24.9.0 vs Render v20.11.0
- pnpm lockfile v9.0 may have compatibility nuances with Node 20.x
- Render using older Node version than local development

**The solution:**
- Update Render to use Node v24.9.0 to match local environment
- Or create .nvmrc file for automatic version detection
- Add diagnostic logging to build command for future debugging

---

## Testing the Fix

### Expected Build Output

After applying the fix, you should see:

```
=== Build Environment ===
Node: v24.9.0
pnpm: 10.18.1

=== Installing dependencies ===
Lockfile is up to date, resolution step is skipped
Packages: +1234
++++++++++++++++++++++++++++++++++++++++++++++++
Progress: resolved 1234, reused 1234, downloaded 0, added 1234, done

=== Verifying @sentry/nextjs ===
@sentry/nextjs 10.23.0

=== Building application ===
✓ Compiled successfully
```

### If Build Still Fails

1. Check Render build logs for the actual Node version being used
2. Verify render.yaml changes are deployed (check git commit in Render)
3. Check for any custom build commands in Render Dashboard overriding render.yaml
4. Verify pnpm-lock.yaml in the deployed commit matches the local file

---

## Contact and Support

**Render Support:** If the issue persists after updating Node version:
- Open a support ticket in Render Dashboard
- Reference this analysis and the version mismatch
- Provide build logs showing the Node version discrepancy

**Local Development:** All developers should:
- Use Node v24.9.0 (via nvm or direct install)
- Use pnpm 10.18.1
- Run `pnpm install` after pulling changes
- Verify builds locally before pushing

---

## File Changes Required

### 1. render.yaml (REQUIRED)

```diff
- key: NODE_VERSION
- value: "20.11.0"
+ value: "24.9.0"
```

### 2. .nvmrc (RECOMMENDED)

Create new file:
```
24.9.0
```

### 3. package.json (OPTIONAL but RECOMMENDED)

```diff
"engines": {
- "node": ">=18.0.0",
+ "node": ">=24.0.0",
  "pnpm": ">=10.0.0"
}
```

---

## Success Metrics

Deployment is successful when:
- ✅ Build completes without errors
- ✅ @sentry/nextjs is found and imported
- ✅ Application starts on Render
- ✅ Health check endpoint responds with 200 OK
- ✅ Sentry error tracking initializes (check Sentry dashboard)

---

**Next Steps:**
1. Update render.yaml with Node v24.9.0
2. Commit and push changes
3. Monitor Render build logs
4. Verify deployment success
5. Test Sentry integration in production
